{% extends 'base.html' %}

{% block title %}Partner Dashboard{% endblock %}

{% block content %}
<h2>Partner Dashboard</h2>
<div class="wallet-info" style="float: right; font-weight: bold;">
    Wallet: ${{ "%.2f"|format(current_user.wallet_balance) }}
</div>
<div class="status-bar">
    Status: <strong>{{ 'Online' if current_user.is_online else 'Offline' }}</strong>
    <a href="{{ url_for('partner.toggle_status') }}">{{ 'Go Offline' if current_user.is_online else 'Go Online' }}</a>
</div>

{% if current_user.is_online %}
<div class="card">
    <h3>Current Area</h3>
    <form action="{{ url_for('partner.set_area') }}" method="POST">
        <select name="area_id" onchange="this.form.submit()">
            <option value="" disabled {{ 'selected' if not current_user.current_area_id else '' }}>Select Area</option>
            {% for area in areas %}
            <option value="{{ area.id }}" {{ 'selected' if current_user.current_area_id == area.id else '' }}>{{ area.name }}</option>
            {% endfor %}
        </select>
    </form>
</div>
{% endif %}

<div class="dashboard-grid">
    <!-- Available Orders -->
    <div class="card">
        <h3>Available Orders in {{ current_area_name if current_area_name else 'Selected Area' }}</h3>
        {% if has_active_order %}
        <p class="notification warning">You have an active order. Please complete it before accepting new ones.</p>
        {% elif available_orders %}
        <ul>
            {% for order in available_orders %}
            <li>
                From: {{ order.pickup_address }} <br>
                To: {{ order.drop_address }} <br>
                Earn: ${{ order.amount - order.commission }}
                <a href="{{ url_for('partner.accept_order', order_id=order.id) }}">Accept</a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No orders available.</p>
        {% endif %}
    </div>

    <!-- Active Orders -->
    <div class="card">
        <h3>My Active Orders</h3>
        {% if my_orders %}
        <ul>
            {% for order in my_orders %}
            <li>
                Order #{{ order.id }} - {{ order.status }}
                {% if order.status == 'accepted' %}
                    <a href="{{ url_for('partner.update_status', order_id=order.id, status='picked_up') }}">Mark Picked Up</a>
                    <a href="{{ url_for('partner.update_status', order_id=order.id, status='declined') }}" style="color: red; margin-left: 10px;">Decline/Cancel</a>
                {% elif order.status == 'picked_up' %}
                     <a href="{{ url_for('partner.update_status', order_id=order.id, status='arrived') }}">Arrived at Drop</a>
                {% elif order.status == 'arrived' %}
                     <a href="{{ url_for('partner.update_status', order_id=order.id, status='completed') }}">Complete</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No active orders.</p>
        {% endif %}
    </div>
</div>

<script>
    setInterval(function() {
         if (document.activeElement.tagName !== "INPUT" && document.activeElement.tagName !== "SELECT") {
            window.location.reload();
        }
    }, 5000);
</script>
{% endblock %}
